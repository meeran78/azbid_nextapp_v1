// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  BUYER
  SELLER
  ADMIN
}

enum AuctionStatus {
  DRAFT
  SCHEDULED
  LIVE
  COMPLETED
  CANCELLED
}

enum LotStatus {
  DRAFT
  SCHEDULED
  LIVE
  SOLD
  UNSOLD
  RESEND
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
  VOID
}

enum StoreStatus {
  PENDING // Awaiting admin approval
  ACTIVE
  SUSPENDED
}

model InvoiceItem {
  id        String  @id @default(uuid())
  invoiceId String
  itemId    String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  item      Item    @relation(fields: [itemId], references: [id])

  @@unique([invoiceId, itemId])
  @@index([invoiceId])
  @@index([itemId])
}

enum CategoryStatus {
  ACTIVE
  INACTIVE
}

model Post {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title   String
  content String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("posts")
}

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name          String
  email         String    @unique
  emailVerified Boolean
  image         String?
  role          UserRole  @default(BUYER)
  banned        Boolean?
  banReason     String?
  banExpires    DateTime?

  // NEW ‚Äì business address / contact
  companyName                 String?
  companyRegistrationNumber   String?
  companyDescription          String?
  companyLogo                 String?
  companyBanner               String?
  companySocialMedia          String?
  companySocialMediaUrl       String?
  companySocialMediaIcon      String?
  companyLocationDescription  String?
  addressLine1                String?
  addressLine2                String?
  city                        String?
  state                       String? // will be driven by dropdown in UI (default ‚ÄúVA‚Äù)
  zipcode                     String?
  country                     String?
  displayLocation             String? // e.g. "Richmond, VA"
  businessPhone               String?
  businessEmail               String?
  businessWebsite             String?
  businessDescription         String?
  businessLogo                String?
  businessBanner              String?
  businessSocialMedia         String?
  businessSocialMediaUrl      String?
  businessSocialMediaIcon     String?
  newsLetterEmailSubscription Boolean? @default(false)
  newsLetterSMSSubscription   Boolean? @default(false)
  acceptedTerms               Boolean  @default(false)
  acceptedTermsAt             DateTime? @default(now())  // When user accepted (optional)

  sessions Session[]
  accounts Account[]
  posts    Post[]

  // Buyer
  bids            Bid[]
  orders          Order[]
  favourites      StoreFavourite[] // NEW: stores this user has favourited
  storeReviews    StoreReview[] // NEW: reviews this user has written
  invoicesAsBuyer Invoice[]        @relation("InvoiceBuyer")

  // Seller
  commissionPct    Float? // Commission % for sellers (0-100), applies to all their stores
  stores           Store[]
  invoicesAsSeller Invoice[] @relation("InvoiceSeller")
  approvedStores   Store[]   @relation("ApprovedBy")
  suspendedStores  Store[]   @relation("SuspendedBy")

  //Lot review fields
  reviewedLots Lot[]      @relation("LotReviewedBy")
  // Admin actions
  adminLogs    AdminLog[]

  //Stripe
  stripeCustomerId String? @unique

  @@map("users")
}

model Session {
  id        String   @id @default(uuid())
  createdAt DateTime
  updatedAt DateTime

  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  impersonatedBy String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id        String   @id @default(uuid())
  createdAt DateTime
  updatedAt DateTime

  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Verification {
  id        String    @id @default(uuid())
  createdAt DateTime?
  updatedAt DateTime?

  identifier String
  value      String
  expiresAt  DateTime

  @@map("verifications")
}

model Store {
  id      String @id @default(uuid())
  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  name        String
  description String?
  logoUrl     String?

  status StoreStatus @default(PENDING) // Single definition

  // NEW: reputation metrics
  averageRating    Float?
  ratingsCount     Int?
  responseRate     Float?
  responseTimeMins Float?
  approvedAt       DateTime?
  approvedById     String?
  approvedBy       User?     @relation("ApprovedBy", fields: [approvedById], references: [id])
  suspendedAt      DateTime?
  suspendedById    String?
  suspendedBy      User?     @relation("SuspendedBy", fields: [suspendedById], references: [id])

  auctions   Auction[]
  lots       Lot[]
  favourites StoreFavourite[]
  reviews    StoreReview[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId, status])
}

model StoreFavourite {
  id      String @id @default(uuid())
  userId  String
  storeId String

  user  User  @relation(fields: [userId], references: [id])
  store Store @relation(fields: [storeId], references: [id])

  createdAt DateTime @default(now())

  @@unique([userId, storeId])
  @@index([storeId])
}

model StoreReview {
  id        String   @id @default(uuid())
  storeId   String
  userId    String // buyer who left the review
  rating    Int // e.g. 1‚Äì5
  comment   String?
  createdAt DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id])
  user  User  @relation(fields: [userId], references: [id])

  @@index([storeId])
  @@index([userId])
}

model Auction {
  id      String @id @default(uuid())
  storeId String
  store   Store  @relation(fields: [storeId], references: [id])

  title       String
  description String?
  status      AuctionStatus @default(DRAFT)

  startAt DateTime
  endAt   DateTime

  // üî• Soft-close config
  softCloseEnabled     Boolean @default(true)
  softCloseWindowSec   Int     @default(120)
  softCloseExtendSec   Int     @default(60)
  softCloseExtendLimit Int     @default(10)

  lots Lot[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId, status])
}

model Lot {
  id           String  @id @default(uuid())
  storeId      String
  auctionId    String?
  lotDisplayId String? @unique

  store   Store    @relation(fields: [storeId], references: [id])
  auction Auction? @relation(fields: [auctionId], references: [id])

  title       String
  description String?
  status      LotStatus @default(DRAFT)

  // Admin review fields
  adminNotes   String? // Notes from admin (e.g. rejection reason)
  reviewedAt   DateTime?
  reviewedById String?
  reviewedBy   User?     @relation("LotReviewedBy", fields: [reviewedById], references: [id])

  // Date & Time fields
  closesAt       DateTime // Closing date & time
  inspectionAt   DateTime? // Inspection date & time (optional)
  removalStartAt DateTime? // Removal start date & time (optional)

  // üî• Soft-close tracking// ‚è±Ô∏è Soft-close fields  
  extendedCount  Int       @default(0)
  lastExtendedAt DateTime?

  items    Item[]
  invoices Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([storeId, auctionId, status])
}

model Item {
  id    String @id @default(uuid())
  lotId String
  lot   Lot    @relation(fields: [lotId], references: [id])

  categoryId String? // Changed from enum to relation
  category   Category? @relation(fields: [categoryId], references: [id])

  title       String
  description String?
  condition   String?
  imageUrls   String[]

  startPrice       Float
  reservePrice     Float?
  currentPrice     Float?
  retailPrice      Float?
  winningBidAmount Float?
  estimatedValue   Float?

  // Relations for bids and orders per item
  bids         Bid[]
  winningBid   Bid?          @relation("WinningBid", fields: [winningBidId], references: [id])
  winningBidId String?       @unique
  orders       Order[]
  invoiceItems InvoiceItem[]

  createdAt DateTime @default(now())

  @@index([lotId])
  @@index([winningBidId])
}

model Bid {
  id     String @id @default(uuid())
  itemId String // Changed from lotId
  userId String

  item          Item  @relation(fields: [itemId], references: [id])
  bidder        User  @relation(fields: [userId], references: [id])
  winningBidFor Item? @relation("WinningBid")

  amount Float
  isAuto Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([itemId, amount])
  @@index([userId])
}

model Order {
  id      String @id @default(uuid())
  buyerId String
  itemId  String // Changed from lotId

  buyer User @relation(fields: [buyerId], references: [id])
  item  Item @relation(fields: [itemId], references: [id])

  subtotal     Float
  buyerPremium Float
  tax          Float
  total        Float

  status PaymentStatus @default(PENDING)

  invoice Invoice?
  payment Payment?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([buyerId, itemId])
  @@index([itemId])
  @@index([buyerId])
}

model Invoice {
  id               String  @id @default(uuid())
  invoiceDisplayId String? @unique // Human-readable ID (e.g. INV-2024-00001)

  // Relations
  orderId String? @unique // Optional: link to Order for backward compatibility
  order   Order?  @relation(fields: [orderId], references: [id])

  buyerId  String
  buyer    User   @relation("InvoiceBuyer", fields: [buyerId], references: [id])
  sellerId String
  seller   User   @relation("InvoiceSeller", fields: [sellerId], references: [id])
  lotId    String
  lot      Lot    @relation(fields: [lotId], references: [id])

  // Item ID(s) - many-to-many via InvoiceItem
  invoiceItems InvoiceItem[]

  // Amounts
  winningBidAmount      Float
  buyerPremiumPct       Float // Buyer's Premium (%)
  tax                   Float? // Tax if applicable
  stripePaymentIntentId String?
  invoiceTotal          Float

  status InvoiceStatus @default(PENDING)

  issuedAt DateTime  @default(now())
  paidAt   DateTime?
}

// Payment (Stripe / Gateway)
model Payment {
  id      String @id @default(uuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  provider    String // STRIPE
  providerRef String // PaymentIntent ID
  amount      Float
  status      PaymentStatus

  failureReason String?

  createdAt DateTime @default(now())
}

//Admin Audit Log
model AdminLog {
  id      String @id @default(uuid())
  adminId String
  admin   User   @relation(fields: [adminId], references: [id])

  action   String
  entity   String
  entityId String?

  createdAt DateTime @default(now())

  @@index([adminId])
}

// Add Category model (place it before the Item model, around line 280)
model Category {
  id          String         @id @default(uuid())
  name        String         @unique
  description String?
  imageUrl    String?
  status      CategoryStatus @default(ACTIVE)

  items Item[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([name])
}

model Faq {
  id        String  @id @default(uuid())
  question  String
  answer    String
  category  String? // e.g. "Bidding", "Payments"
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
